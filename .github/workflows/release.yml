name: Release

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

# Add permissions for package publishing
permissions:
  contents: read
  packages: write
  id-token: write
  pull-requests: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          registry-url: "https://npm.pkg.github.com"
          scope: "@a-little-world"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.0.0

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Packages
        run: pnpm build

      - name: Preview Package Versions
        if: github.event_name == 'pull_request'
        run: |
          echo "## ðŸ“¦ Package Version Preview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“Š Current Package Versions:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|" >> $GITHUB_STEP_SUMMARY

          for package in packages/*/package.json; do
            if [ -f "$package" ]; then
              PACKAGE_NAME=$(node -e "console.log(require('$(pwd)/$package').name)" 2>/dev/null || echo "Unknown")
              PACKAGE_VERSION=$(node -e "console.log(require('$(pwd)/$package').version)" 2>/dev/null || echo "Unknown")
              echo "| $PACKAGE_NAME | $PACKAGE_VERSION |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ What will happen when this PR is merged to main:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Packages will be published to npm with their current versions" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub releases will be created for each published package" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Make sure to bump package versions locally before merging to trigger releases." >> $GITHUB_STEP_SUMMARY

      - name: Comment PR with Version Preview
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## ðŸ“¦ Analyzing package version changes..." >> $GITHUB_STEP_SUMMARY

          # Get the merge base with origin/main for proper version comparison
          MERGE_BASE=$(git merge-base HEAD origin/main 2>/dev/null || echo "")

          if [ -z "$MERGE_BASE" ]; then
            echo "âš ï¸ Could not determine merge base, showing current versions only" >> $GITHUB_STEP_SUMMARY
            # Fallback: just show current versions without comparison
            COMMENT_BODY="## ðŸ“¦ Package Version Preview

            ### ðŸ“Š Current Package Versions:

            | Package | Version |
            |---------|---------|
            "

            # Show current versions of all packages
            for package in packages/*/package.json; do
              if [ -f "$package" ]; then
                PACKAGE_NAME=$(node -e "console.log(require('$(pwd)/$package').name)" 2>/dev/null || echo "Unknown")
                PACKAGE_VERSION=$(node -e "console.log(require('$(pwd)/$package').version)" 2>/dev/null || echo "Unknown")
                COMMENT_BODY+="| $PACKAGE_NAME | $PACKAGE_VERSION |"$'\n'
              fi
            done

            COMMENT_BODY+="

            ### ðŸ“‹ Summary:
            âš ï¸ **Version comparison unavailable.** Please check package.json files manually to see if versions have changed.

            ---
            *This comment updates automatically on each commit.*"
          else
            echo "Comparing against merge base: $MERGE_BASE" >> $GITHUB_STEP_SUMMARY

            # Get the previous commit's package versions from the merge base
            git show $MERGE_BASE:packages/core/package.json > /tmp/prev_core.json 2>/dev/null || echo '{"version": "0.0.0"}' > /tmp/prev_core.json
            git show $MERGE_BASE:packages/web/package.json > /tmp/prev_web.json 2>/dev/null || echo '{"version": "0.0.0"}' > /tmp/prev_web.json
            git show $MERGE_BASE:packages/native/package.json > /tmp/prev_native.json 2>/dev/null || echo '{"version": "0.0.0"}' > /tmp/prev_native.json

            # Get current versions
            CORE_VERSION=$(node -e "console.log(require('./packages/core/package.json').version)")
            WEB_VERSION=$(node -e "console.log(require('./packages/web/package.json').version)")
            NATIVE_VERSION=$(node -e "console.log(require('./packages/native/package.json').version)")

            # Get previous versions
            PREV_CORE_VERSION=$(node -e "console.log(require('/tmp/prev_core.json').version)")
            PREV_WEB_VERSION=$(node -e "console.log(require('/tmp/prev_web.json').version)")
            PREV_NATIVE_VERSION=$(node -e "console.log(require('/tmp/prev_native.json').version)")

            # Create the comment content
            COMMENT_BODY="## ðŸ“¦ Package Version Analysis

            ### ðŸ”„ Version Changes:

            | Package | Previous | Current | Status |
            |---------|----------|---------|--------|
            "

            # Check each package for changes
            CORE_CHANGED=false
            WEB_CHANGED=false
            NATIVE_CHANGED=false

            if [ "$CORE_VERSION" != "$PREV_CORE_VERSION" ]; then
              COMMENT_BODY+="| @a-little-world/little-world-design-system-core | $PREV_CORE_VERSION | **$CORE_VERSION** | âœ… **Will be published** |"$'\n'
              CORE_CHANGED=true
            else
              COMMENT_BODY+="| @a-little-world/little-world-design-system-core | $PREV_CORE_VERSION | $CORE_VERSION | â­ï¸ No change |"$'\n'
            fi

            if [ "$WEB_VERSION" != "$PREV_WEB_VERSION" ]; then
              COMMENT_BODY+="| @a-little-world/little-world-design-system | $PREV_WEB_VERSION | **$WEB_VERSION** | âœ… **Will be published** |"$'\n'
              WEB_CHANGED=true
            else
              COMMENT_BODY+="| @a-little-world/little-world-design-system | $PREV_WEB_VERSION | $WEB_VERSION | â­ï¸ No change |"$'\n'
            fi

            if [ "$NATIVE_VERSION" != "$PREV_NATIVE_VERSION" ]; then
              COMMENT_BODY+="| @a-little-world/little-world-design-system-native | $PREV_NATIVE_VERSION | **$NATIVE_VERSION** | âœ… **Will be published** |"$'\n'
              NATIVE_CHANGED=true
            else
              COMMENT_BODY+="| @a-little-world/little-world-design-system-native | $PREV_NATIVE_VERSION | $NATIVE_VERSION | â­ï¸ No change |"$'\n'
            fi

            COMMENT_BODY+="

            ### ðŸ“‹ Summary:"

            if [ "$CORE_CHANGED" = true ] || [ "$WEB_CHANGED" = true ] || [ "$NATIVE_CHANGED" = true ]; then
              COMMENT_BODY+="
              ðŸŽ‰ **This PR will trigger releases!** The following packages will be published to npm:"
              
              if [ "$CORE_CHANGED" = true ]; then
                COMMENT_BODY+="
              - @a-little-world/little-world-design-system-core@$CORE_VERSION"
              fi
              
              if [ "$WEB_CHANGED" = true ]; then
                COMMENT_BODY+="
              - @a-little-world/little-world-design-system@$WEB_VERSION"
              fi
              
              if [ "$NATIVE_CHANGED" = true ]; then
                COMMENT_BODY+="
              - @a-little-world/little-world-design-system-native@$NATIVE_VERSION"
              fi
              
              COMMENT_BODY+="

              A GitHub release will also be created with changelog information."
            else
              COMMENT_BODY+="
              âš ï¸ **No version changes detected.** This PR will not trigger any releases.
              
              To trigger a release, bump the version in the relevant package.json file(s) before merging."
            fi

            COMMENT_BODY+="

            ---
            *This comment updates automatically on each commit.*"
          fi

          # Create or update the comment (edit last if exists, create if none)
          gh pr comment ${{ github.event.pull_request.number }} --body "$COMMENT_BODY" --edit-last --create-if-none

      - name: Check for Version Changes
        if: github.ref == 'refs/heads/main'
        id: version-check
        run: |
          echo "Checking for version changes..." >> $GITHUB_STEP_SUMMARY

          # For main branch, compare against the previous commit
          PREV_COMMIT=$(git rev-parse HEAD~1 2>/dev/null || echo "")

          if [ -z "$PREV_COMMIT" ]; then
            echo "âš ï¸ No previous commit found, assuming first commit" >> $GITHUB_STEP_SUMMARY
            # If this is the first commit, assume all packages have changed
            CORE_VERSION=$(node -e "console.log(require('./packages/core/package.json').version)")
            WEB_VERSION=$(node -e "console.log(require('./packages/web/package.json').version)")
            NATIVE_VERSION=$(node -e "console.log(require('./packages/native/package.json').version)")
            
            echo "âœ… First commit detected, all packages will be published" >> $GITHUB_STEP_SUMMARY
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_packages=core web native" >> $GITHUB_OUTPUT
          else
            echo "Comparing against previous commit: $PREV_COMMIT" >> $GITHUB_STEP_SUMMARY

            # Get the previous commit's package versions
            git show $PREV_COMMIT:packages/core/package.json > /tmp/prev_core.json 2>/dev/null || echo '{"version": "0.0.0"}' > /tmp/prev_core.json
            git show $PREV_COMMIT:packages/web/package.json > /tmp/prev_web.json 2>/dev/null || echo '{"version": "0.0.0"}' > /tmp/prev_web.json
            git show $PREV_COMMIT:packages/native/package.json > /tmp/prev_native.json 2>/dev/null || echo '{"version": "0.0.0"}' > /tmp/prev_native.json

            # Get current versions
            CORE_VERSION=$(node -e "console.log(require('./packages/core/package.json').version)")
            WEB_VERSION=$(node -e "console.log(require('./packages/web/package.json').version)")
            NATIVE_VERSION=$(node -e "console.log(require('./packages/native/package.json').version)")

            # Get previous versions
            PREV_CORE_VERSION=$(node -e "console.log(require('/tmp/prev_core.json').version)")
            PREV_WEB_VERSION=$(node -e "console.log(require('/tmp/prev_web.json').version)")
            PREV_NATIVE_VERSION=$(node -e "console.log(require('/tmp/prev_native.json').version)")

            # Check if versions changed
            VERSION_CHANGES=""

            if [ "$CORE_VERSION" != "$PREV_CORE_VERSION" ]; then
              VERSION_CHANGES="$VERSION_CHANGES core"
              echo "âœ… Core version changed: $PREV_CORE_VERSION â†’ $CORE_VERSION" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "$WEB_VERSION" != "$PREV_WEB_VERSION" ]; then
              VERSION_CHANGES="$VERSION_CHANGES web"
              echo "âœ… Web version changed: $PREV_WEB_VERSION â†’ $WEB_VERSION" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "$NATIVE_VERSION" != "$PREV_NATIVE_VERSION" ]; then
              VERSION_CHANGES="$VERSION_CHANGES native"
              echo "âœ… Native version changed: $PREV_NATIVE_VERSION â†’ $NATIVE_VERSION" >> $GITHUB_STEP_SUMMARY
            fi

            if [ -z "$VERSION_CHANGES" ]; then
              echo "âŒ No version changes detected" >> $GITHUB_STEP_SUMMARY
              echo "has_changes=false" >> $GITHUB_OUTPUT
            else
              echo "ðŸŽ‰ Version changes detected: $VERSION_CHANGES" >> $GITHUB_STEP_SUMMARY
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "changed_packages=$VERSION_CHANGES" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Publish Packages
        if: github.ref == 'refs/heads/main' && steps.version-check.outputs.has_changes == 'true'
        run: |
          echo "## ðŸ“¦ Publishing packages..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          CHANGED_PACKAGES="${{ steps.version-check.outputs.changed_packages }}"

          for package in $CHANGED_PACKAGES; do
            echo "### Publishing $package..." >> $GITHUB_STEP_SUMMARY
            
            if [ "$package" = "core" ]; then
              echo "Running: pnpm --filter=@a-little-world/little-world-design-system-core publish --access restricted" >> $GITHUB_STEP_SUMMARY
              if pnpm --filter=@a-little-world/little-world-design-system-core publish --access restricted; then
                echo "âœ… Successfully published @a-little-world/little-world-design-system-core" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ Failed to publish @a-little-world/little-world-design-system-core" >> $GITHUB_STEP_SUMMARY
                exit 1
              fi
            elif [ "$package" = "native" ]; then
              echo "Running: pnpm --filter=@a-little-world/little-world-design-system-native publish --access restricted" >> $GITHUB_STEP_SUMMARY
              if pnpm --filter=@a-little-world/little-world-design-system-native publish --access restricted; then
                echo "âœ… Successfully published @a-little-world/little-world-design-system-native" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ Failed to publish @a-little-world/little-world-design-system-native" >> $GITHUB_STEP_SUMMARY
                exit 1
              fi
            elif [ "$package" = "web" ]; then
              echo "Running: pnpm --filter=@a-little-world/little-world-design-system publish --access restricted" >> $GITHUB_STEP_SUMMARY
              if pnpm --filter=@a-little-world/little-world-design-system publish --access restricted; then
                echo "âœ… Successfully published @a-little-world/little-world-design-system" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ Failed to publish @a-little-world/little-world-design-system" >> $GITHUB_STEP_SUMMARY
                exit 1
              fi
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
          done

          echo "ðŸŽ‰ All packages published successfully!" >> $GITHUB_STEP_SUMMARY
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        if: github.ref == 'refs/heads/main' && steps.version-check.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## ðŸ·ï¸ Creating GitHub Release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          CHANGED_PACKAGES="${{ steps.version-check.outputs.changed_packages }}"

          # Create release notes
          echo "## Released Packages" > release_notes.md
          echo "" >> release_notes.md

          for package in $CHANGED_PACKAGES; do
            if [ "$package" = "core" ]; then
              PACKAGE_NAME="@a-little-world/little-world-design-system-core"
              PACKAGE_VERSION=$(node -e "console.log(require('./packages/core/package.json').version)")
              PACKAGE_PATH="packages/core"
            elif [ "$package" = "native" ]; then
              PACKAGE_NAME="@a-little-world/little-world-design-system-native"
              PACKAGE_VERSION=$(node -e "console.log(require('./packages/native/package.json').version)")
              PACKAGE_PATH="packages/native"
            elif [ "$package" = "web" ]; then
              PACKAGE_NAME="@a-little-world/little-world-design-system"
              PACKAGE_VERSION=$(node -e "console.log(require('./packages/web/package.json').version)")
              PACKAGE_PATH="packages/web"
            fi

            echo "### $PACKAGE_NAME" >> release_notes.md
            echo "" >> release_notes.md
            echo "**Version:** $PACKAGE_VERSION" >> release_notes.md
            echo "" >> release_notes.md

            # Get changelog content for this package
            if [ -f "$PACKAGE_PATH/CHANGELOG.md" ]; then
              echo "**Changes:**" >> release_notes.md
              echo "" >> release_notes.md
              # Extract the latest version section from changelog
              sed -n "/^## \[$PACKAGE_VERSION\]/,/^## /p" "$PACKAGE_PATH/CHANGELOG.md" | head -n -1 >> release_notes.md
              echo "" >> release_notes.md
            fi
          done

          # Create the GitHub release with a unique tag for the day
          BASE_TAG="v$(date +%Y.%m.%d)"
          TAG=$BASE_TAG
          COUNTER=1
          while gh release view $TAG --repo ${{ github.repository }} &>/dev/null; do
            TAG="${BASE_TAG}-$COUNTER"
            COUNTER=$((COUNTER+1))
          done
          gh release create $TAG \
            --title "Release $TAG" \
            --notes-file release_notes.md \
            --repo ${{ github.repository }}

          echo "âœ… Created GitHub release: $TAG" >> $GITHUB_STEP_SUMMARY
